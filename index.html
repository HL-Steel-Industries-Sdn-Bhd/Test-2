<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>工人扫码 - Angelina</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <style>
    :root { --left-w:35%; --focus-border:3px; --overlay-dark: rgba(0,0,0,0.45); }
    html,body{height:100%;margin:0;font-family:"Segoe UI",Arial,sans-serif;}
    body { display:flex; height:100vh; background:#f4f6f9; overflow:hidden; }

    /* 左侧扫码区（固定宽度百分比） */
    #leftPanel {
      flex: 0 0 var(--left-w);
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:18px 12px;
      gap:12px;
      background: linear-gradient(180deg,#fff,#f1f4ff);
      box-shadow: 2px 0 8px rgba(0,0,0,0.06);
    }
    #leftPanel h2 { margin:0;color:#34495e;font-size:16px; }

    /* reader（正方形 viewfinder）*/
    #reader {
      width:92%;
      max-width:520px;
      aspect-ratio: 1 / 1; /* 保证正方形 */
      border-radius:12px;
      overflow:hidden;
      position:relative;
      background:#000;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    }
    /* 让 html5-qrcode 插入的 video/canvas 填满 reader */
    #reader video, #reader canvas {
      width:100% !important;
      height:100% !important;
      object-fit: cover !important;
      display:block;
    }

    /* 焦点框与暗化外部 */
    .overlay { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; }
    #focusBox {
      box-sizing:border-box;
      border: var(--focus-border) solid #00e676;
      border-radius:8px;
      /* 暗化框外 */
      box-shadow: 0 0 0 9999px var(--overlay-dark);
      pointer-events:none;
      transition: width .12s, height .12s;
    }

    /* 输入框 */
    #scannerInput {
      width:92%;
      padding:8px 10px;
      border-radius:6px;
      border:1px solid #ccc;
      font-size:14px;
    }

    /* 右侧结果区 */
    #rightPanel { flex:1; display:flex; flex-direction:column; min-width:0; }
    #currentBox { background:#fff; padding:12px 16px; border-bottom:1px solid #e6e9ee; position:sticky; top:0; z-index:5; }
    #currentBox h3 { margin:0 0 6px 0;color:#2c3e50;font-size:16px; }
    #currentInfo{ color:#34495e; font-size:14px; line-height:1.5; }
    #countBox{ margin-top:8px;color:#ff9800;font-weight:700; }

    #listBox { flex:1; overflow:auto; padding:12px; background:#f7f9fc; }
    table{ width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; }
    th,td{ padding:10px; font-size:14px; border:1px solid #eee; text-align:left; }
    th{ background:#fbfbfd; font-weight:700; }
    tr:nth-child(even){ background:#fafafa; }

    /* toast */
    #toast { position:fixed; bottom:20px; right:20px; background:#333; color:#fff; padding:10px 14px; border-radius:8px; opacity:0; transform:translateY(8px); transition:opacity .24s, transform .24s; z-index:9999; pointer-events:none; }
    #toast.show { opacity:1; transform:translateY(0); }

    @media (max-width:900px) {
      :root { --left-w:40%; }
      #reader { max-width:420px; }
    }
  </style>
</head>
<body>
  <!-- 左边扫码区 -->
  <div id="leftPanel">
    <h2>Welcome Angelina (A0001)</h2>
    <div id="reader">
      <!-- html5-qrcode 会在这里插入 video/canvas -->
      <div class="overlay"><div id="focusBox" aria-hidden="true"></div></div>
    </div>
    <input id="scannerInput" placeholder="请扫描图纸或粘贴 URL 后按 Enter" />
  </div>

  <!-- 右边结果区 -->
  <div id="rightPanel">
    <div id="currentBox">
      <h3>当前扫描结果</h3>
      <div id="currentInfo">等待扫描...</div>
      <div id="countBox">已扫描 0 张图纸</div>
    </div>

    <div id="listBox">
      <table id="resultTable">
        <thead>
          <tr><th>Sales Order No.</th><th>Item No.</th><th>Name</th><th>Units</th><th>Dimension</th><th>Link</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    // 允许的图纸 domain/path（按需改）
    const ALLOWED_HOST = "yourdomain.github.io";
    const ALLOWED_PATH = "/repo";

    const html5QrCode = new Html5Qrcode("reader", { verbose: false });

    const scannerInput = document.getElementById("scannerInput");
    const toast = document.getElementById("toast");
    const resultTbody = document.querySelector("#resultTable tbody");
    const currentInfo = document.getElementById("currentInfo");
    const countBox = document.getElementById("countBox");
    const readerEl = document.getElementById("reader");
    const focusBox = document.getElementById("focusBox");

    let scannedLinks = new Set();
    let lastDuplicateTime = 0;
    let toastTimer = null;

    function showToast(msg, bg) {
      toast.textContent = msg;
      toast.style.backgroundColor = bg || "#333";
      toast.classList.add("show");
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => { toast.classList.remove("show"); toastTimer = null; }, 2000);
    }

    function updateCount() {
      countBox.textContent = "已扫描 " + scannedLinks.size + " 张图纸";
    }

    function normalizePath(p){ return (p||"").replace(/\/+$/,""); }

    function isPaperUrl(u){
      try {
        const host = (u.hostname || "").toLowerCase();
        const path = normalizePath(u.pathname || "");
        const hasParams = u.searchParams.get("so") && u.searchParams.get("item");
        return host === ALLOWED_HOST && path === ALLOWED_PATH && hasParams;
      } catch(e){ return false; }
    }

    function formatDataFromUrl(u){
      const normalizedUrl = u.origin + normalizePath(u.pathname) + (u.search || "");
      let salesOrder = u.searchParams.get("so") || "";
      let item = u.searchParams.get("item") || "";
      let name = u.searchParams.get("name") || "";
      let unit = u.searchParams.get("unit") || "";
      let dim = u.searchParams.get("dim") || "";
      if (salesOrder) salesOrder = salesOrder.replace(/^SO-?/i, "SO-");
      if (dim) dim = dim.replace(/x/g, " x ") + " mm";
      if (name) name = decodeURIComponent(name).replace(/\+/g," ");
      return { salesOrder, item, name, unit, dim, url: normalizedUrl };
    }

    function displayCurrent(data){
      currentInfo.innerHTML = `
        <b>Sales Order:</b> ${data.salesOrder || "-"} <br>
        <b>Item No.:</b> ${data.item || "-"} <br>
        <b>Name:</b> ${data.name || "-"} <br>
        <b>Units:</b> ${data.unit || "-"} <br>
        <b>Dimension:</b> ${data.dim || "-"} <br>
        <b>Link:</b> <a href="${data.url}" target="_blank" rel="noopener">${data.url}</a>
      `;
    }

    function addToList(data){
      if (scannedLinks.has(data.url)) {
        const now = Date.now();
        if (now - lastDuplicateTime > 3000) {
          lastDuplicateTime = now;
          showToast("已扫描过该图纸", "#ff9800");
        }
        return;
      }
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${data.salesOrder}</td><td>${data.item}</td><td>${data.name}</td><td>${data.unit}</td><td>${data.dim}</td><td><a href="${data.url}" target="_blank" rel="noopener">Link</a></td>`;
      resultTbody.prepend(tr);
      scannedLinks.add(data.url);
      updateCount();
      showToast("已加入扫描记录", "#007bff");
    }

    function handleScannedText(text){
      if (!text) return;
      text = text.trim();
      try {
        const u = new URL(text);
        if (isPaperUrl(u)) {
          const data = formatDataFromUrl(u);
          displayCurrent(data);
          addToList(data);
        } else {
          currentInfo.textContent = "非图纸 QR，已忽略: " + text;
          showToast("非图纸 QR 已忽略", "#333");
        }
      } catch (e) {
        currentInfo.textContent = "无效的 QR 内容: " + text;
        showToast("无效的 QR 内容", "#e74c3c");
      }
    }

    // 计算焦框大小（reader 宽度的 70%）
    function calcFocusSize(){
      const w = Math.max(80, readerEl.clientWidth || 200);
      return Math.floor(w * 0.7);
    }
    function resizeFocusBox(){
      const s = calcFocusSize();
      focusBox.style.width = s + "px";
      focusBox.style.height = s + "px";
      focusBox.style.boxShadow = "0 0 0 9999px rgba(0,0,0,0.45)";
    }
    window.addEventListener("resize", resizeFocusBox);

    // qrbox 函数（html5-qrcode 将传入 viewfinderW/H）
    const qrboxFunc = (viewfinderWidth, viewfinderHeight) => {
      // 优先使用实际 reader 宽度（更贴合 UI）
      const size = calcFocusSize();
      return { width: size, height: size };
    };

    // Scanner 配置（优化小/模糊码识别）
    const scannerConfig = {
      fps: 7,
      qrbox: qrboxFunc,
      disableFlip: false // 允许自动翻转，若你想关掉可设 true
    };

    // 启动扫描（稳健调用：用 facingMode 简洁启动）
    function startScanner(){
      // 停止旧的（若已运行）
      if (html5QrCode && html5QrCode.getState && html5QrCode.getState() === Html5QrcodeScannerState?.SCANNING) {
        // already scanning
      }
      Html5Qrcode.getCameras().then(cameras => {
        let pref = { facingMode: "environment" };
        // 尝试优先使用已识别的后置设备 ID（若可用）
        if (cameras && cameras.length) {
          for (const c of cameras) {
            const lbl = (c.label||"").toLowerCase();
            if (lbl.includes("back") || lbl.includes("rear") || lbl.includes("后")) {
              // use deviceId exact when available for stability
              pref = { deviceId: { exact: c.id } };
              break;
            }
          }
        }
        html5QrCode.start(
          pref,
          scannerConfig,
          (decodedText, decodedResult) => { handleScannedText(decodedText); },
          (errorMessage) => { /* per-frame error, ignore silently */ }
        ).then(() => {
          // 等 video ready 后调整焦框
          setTimeout(resizeFocusBox, 260);
          // 另外周期性微调（应对某些手机延迟渲染）
          setTimeout(resizeFocusBox, 800);
        }).catch(err => {
          console.error("启动扫描失败:", err);
          showToast("相机启动失败，请允许相机权限或刷新页面", "#e74c3c");
        });
      }).catch(err => {
        console.error("获取相机失败:", err);
        showToast("无法访问相机", "#e74c3c");
      });
    }

    // 手动输入支持（按 Enter）
    scannerInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        const t = scannerInput.value.trim();
        if (t) handleScannedText(t);
        scannerInput.value = "";
      }
    });

    // 卸载时停止相机
    window.addEventListener("beforeunload", () => {
      if (html5QrCode) {
        html5QrCode.stop().catch(()=>{});
      }
    });

    // 启动
    startScanner();
    // 保险起见，延迟再做一次 resize
    setTimeout(resizeFocusBox, 400);
  </script>
</body>
</html>
















